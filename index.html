<html>
<head>
	<script src="firebase.js"></script>
	<script src="jquery.min.js"></script>
</head>
<body>
	<h1>App</h1>
	<h2 data='username'></h2>
	<p data='userMsg'></p>
	<p data='dob'></p>
	<p data='age'></p>
	<p data='starSign'></p>
	<script>
  		var fb = new Firebase("https://blinding-fire-3623.firebaseio.com/");
		var map = {
			username: 'user',
			firstname: 'firstname',
			lastname: 'lastname',
			userMsg: ['firstname', 'lastname', function(firstname, lastname) {
				return 'Welcome ' + firstname + ' ' + lastname;
			}],
			dob: 'dob',
			age: ['dob', function(dob) {
				var dobSplit = dob.split('/');
				var year = parseInt(dobSplit[dobSplit.length - 1], 10);
				var fullyear = (year < 15 ? 2000 : 1900) + year
				return 'Roughly ' + (2014 - fullyear);
			}],
			starSign: ['dob', function(dob) {
				var dobSplit = dob.split('/');
				var month = parseInt(dobSplit[1], 10);
				return month < 7 ? 'early' : 'late';
			}]
		};

		function RelationalBinder(map) {
			this.map = map;
			this.viewModel = {};
			this.dependencyMap = {};
		}
		RelationalBinder.prototype = {
			constructor: RelationalBinder,
			init: function() {
				this.processMap();
				this.processCalculatedProperties();
				this.bind();
			},
			processMap: function() {
				Object.keys(this.map)
					.forEach(this.processMapping.bind(this));
			},
			processMapping: function(property) {
				var mapping = this.map[property];
				if(typeof mapping === 'string') {
					fb.child(property).once('value', this.setPropertyFromSnapshot.bind(this, property));
				} else {
					var callback = mapping.pop();
					mapping.forEach(this.registerDependency.bind(this, {
						prop: property,
						cb: callback,
						deps: mapping
					}));
				}
			},
			setPropertyFromSnapshot: function(property, snapshot) {
				this.viewModel[property] = snapshot.val();
				this.updatePropertyInView(property, this.viewModel[property]);
			},
			updatePropertyInView: function(property, value) {
				$('[data='+property+']').text(value);
			},
			registerDependency: function(relationship, dependency) {
				if(!this.dependencyMap[dependency]) {
					this.dependencyMap[dependency] = [];
				}
				this.dependencyMap[dependency].push(relationship);
			},
			processCalculatedProperties: function() {
				var processed = [];
				Object.keys(this.dependencyMap)
					.forEach(this.processDependency.bind(this, processed));
			},
			processDependency: function(processed, dep) {
				this.dependencyMap[dep].forEach(this.processDependencyRelationship.bind(this, processed));
			},
			processDependencyRelationship: function(processed, relationship) {
				var sig = relationship.prop;
				if(processed.indexOf(sig) < 0) {
					this.updateDependency(relationship);
					processed.push(sig);
				}
			},
			updateDependency: function(relationship) {
				$.when.apply($.when, relationship.deps.map(this.fetchValue.bind(this))).done(this.applyDependency.bind(this, relationship));
			},
			fetchValue: function(property) {
				var promise = $.Deferred();
				fb.child(property).once('value', this.resolvePromiseWithSnapshot.bind(this, promise));
				return promise;
			},
			resolvePromiseWithSnapshot: function(promise, snapshot) {
				promise.resolve(snapshot.val());
			},
			applyDependency: function(relationship) {
				var args = Array.prototype.slice.call(arguments);
				args.shift();
				this.viewModel[relationship.prop] = relationship.cb.apply(this, args);
				this.updatePropertyInView(relationship.prop, this.viewModel[relationship.prop]);
			},
			bind: function() {
				fb.on('child_changed', this.onChildChanged.bind(this));
				Object.observe(this.viewModel, this.onViewModelChange.bind(this));
			},
			onChildChanged: function(snapshot) {
				this.viewModel[snapshot.name()] = snapshot.val();
			},
			onViewModelChange: function(changes) {
				var processed = [];
				changes.forEach(this.processViewModelChange.bind(this, processed));
			},
			processViewModelChange: function(processed, change) {
				var prop = change.name;
				if(this.dependencyMap[prop]) {
					this.dependencyMap[prop].forEach(this.processDependencyRelationship.bind(this, processed));
				}
				this.updatePropertyInView(prop, this.viewModel[prop]);
			}
		};
		var rb = new RelationalBinder(map);
		rb.init();
	</script>
</body>
</html>